#!/usr/bin/env bash

# Find the current file directory, supporting symlinks
WEX_DIR_CLI="$(realpath "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")")/"

# Source initialization scripts
. "${WEX_DIR_CLI}/_init.sh"
. "${WEX_DIR_CLI}/_init_sudo.sh"

# Set WEX_DIR_ROOT
WEX_DIR_ROOT=$(realpath "${WEX_DIR_CLI}../")/

echo "Checking Python requirements..."

# Function to check if a command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Function to install a package if not present
install_if_missing() {
    local package=$1
    local check_command=${2:-$1}
    
    if ! command_exists "$check_command"; then
        echo "Installing ${package}..."
        sudo apt-get -y install "$package"
    fi
}

# Update package list
echo "Updating package list..."
sudo apt-get update

# Install required system packages
install_if_missing "python3-pip" "pip"
install_if_missing "python3-venv"
install_if_missing "procps" "ps"
install_if_missing "sshpass"
install_if_missing "libpq-dev" "psql"

# Setup Python virtual environment
echo "Setting up Python virtual environment..."
VENV_PATH="${WEX_DIR_ROOT}.wex/python/venv"

# Remove existing venv if present
if [ -d "$VENV_PATH" ]; then
    echo "Removing existing virtual environment..."
    rm -rf "$VENV_PATH"
fi

# Create new virtual environment with copied binaries (not symlinks)
echo "Creating new virtual environment..."
python3 -m venv "$VENV_PATH" --clear --copies

# Fix permissions
echo "Fixing virtual environment permissions..."
sudo chown -R "$USER:$USER" "$VENV_PATH"

# Activate virtual environment
echo "Activating virtual environment..."
# shellcheck disable=SC1090
. "${VENV_PATH}/bin/activate"

# Upgrade pip and setuptools
echo "Upgrading pip and setuptools..."
pip install --upgrade pip setuptools wheel

echo "Installing Python requirements..."
pip install -r "${WEX_DIR_ROOT}requirements.txt"

echo "Cleanup..."
sudo rm -f "${WEX_DIR_ROOT}tmp/registry.yml"

echo "Configuring..."
WEX_ENV_PATH="${WEX_DIR_ROOT}.wex/.env"
if [ ! -f "${WEX_ENV_PATH}" ]; then
    echo "APP_ENV=prod" > "${WEX_ENV_PATH}"
fi

echo "Installing core..."
bash "${WEX_DIR_CLI}wex" core::core/install

echo "Reload bashrc changes..."
# shellcheck disable=SC1090
. ~/.bashrc

echo "Installation complete!"
