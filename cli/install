#!/usr/bin/env bash

# Exit immediately if a command exits with a non-zero status.
set -e

# Find the current file directory, supporting symlinks
WEX_DIR_CLI="$(realpath "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")")/"

# Source initialization scripts
. "${WEX_DIR_CLI}/_init.sh"
. "${WEX_DIR_CLI}/_init_sudo.sh"

# Set WEX_DIR_ROOT
WEX_DIR_ROOT=$(realpath "${WEX_DIR_CLI}../")/

echo "Checking Python requirements..."

# Function to check if a command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Optional: allow skipping apt and/or pip when running under dpkg postinst
# Set WEX_SKIP_APT=1 to skip apt operations
# Set WEX_SKIP_PIP=1 to skip pip/venv installation

if [ -z "${WEX_SKIP_APT}" ]; then
  sudo apt-get update

  # Install python3-pip and python3-venv if not installed
  if ! command_exists pip; then
      echo "Installing python3-pip and python3-venv..."
      sudo apt-get -y install python3-pip python3-venv
  fi

  # Install procps if not installed
  if ! command_exists ps; then
      echo "Installing procps..."
      sudo apt-get -y install procps
  fi

  # Install sshpass if not installed
  if ! command_exists sshpass; then
      echo "Installing sshpass..."
      sudo apt-get -y install sshpass
  fi

  # Install libpq client if not installed (runtime lib, not -dev)
  if ! command_exists psql; then
      echo "Installing postgresql-client..."
      sudo apt-get -y install postgresql-client
  fi
fi

# Create and activate virtual environment
VENV_PATH="${WEX_DIR_ROOT}.wex/python/venv"
if [ -z "${WEX_SKIP_PIP}" ]; then
  python3 -m venv "$VENV_PATH" --clear
  # Activate virtual environment
  . "${VENV_PATH}/bin/activate"
  echo "Installing Python requirements..."
  pip install -r "${WEX_DIR_ROOT}requirements.txt"
else
  # Ensure venv exists if expected to be pre-baked by the package
  if [ ! -x "${VENV_PATH}/bin/python" ]; then
    echo "ERROR: WEX_SKIP_PIP=1 but venv is missing at ${VENV_PATH}" >&2
    exit 1
  fi
fi

echo "Cleanup..."
sudo rm -f "${WEX_DIR_ROOT}tmp/registry.yml"

echo "Configuring..."
WEX_ENV_PATH="${WEX_DIR_ROOT}.wex/.env"
if [ ! -f "${WEX_ENV_PATH}" ]; then
    echo "APP_ENV=prod" > "${WEX_ENV_PATH}"
fi

echo "Installing core..."
bash "${WEX_DIR_CLI}wex" core::core/install

echo "Reload bashrc changes..."
# shellcheck disable=SC1090
. ~/.bashrc
